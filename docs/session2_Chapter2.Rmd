---
title: "Chapter2 統計の基礎"
output: 
  github_document:
    toc: TRUE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
set.seed(123)
```

## 2.1 尺度水準
- 人種、車のメーカー、社員の所属部署
- 順位、成績(優/良/可/不可)、顧客満足度
- 温度、日付
- 長さ、重さ、割合に意味があるもの

## 2.2 代表値
平均を求める関数はmean()。
```{r}
X = c(0, 7, 8, 9, 100)
mean(X)
```

mean関数には、na.rmというオプションがある。
```{r}
Y = c(0, 7, 8, NA, 0/0)
Y
mean(Y)
mean(Y, na.rm = TRUE)
```

mean関数には、trimというオプションもある。
```{r}
mean(X, trim = 0.2)
mean(Y, trim = 0.2)
mean(Y, trim = 0.2, na.rm = TRUE)
```

中央値はmedian()という関数で求める。
```{r}
median(X)
median(Y)
median(Y, na.rm = TRUE)
```

平均値と中央値、どちらを使ったらいいかは、ヒストグラムの形によってことなる。

```{r}
hist(rnorm(10000)) # 標準正規分布のヒストグラム
hist(rchisq(10000, 10)) # 自由度10のカイ二乗分布の(以下略)
hist(rcauchy(10000)) # コーシー分布の(以下略)
```

## 2.3 確率変数、乱数、母集団、標本

確率変数と乱数は同じ意味合い。ただし、教科書では、以下の二つのルールに従っている。

1. 確率変数が何らかの「同じ種類のヒストグラム(確率分布が同じ, identically distibuted)」にしたがい
1. 乱数を選ぶときは、「選ぶ」という行為が互いに影響を与えない(独立, independent)

母集団と標本の関係を会社で例えると、

- 母集団：社員全員
- 大きさnの(一つの)標本：社員をランダムにn人選んだときの集団 ※ nのことを(サンプル)サイズという。標本数とは言わない。

母平均と標本平均を、上記の母集団と標本の身長を例に考えてみる。

- 身長の母平均：社員全員の身長の平均。何回計算しても同じ値。
- 身長の標本平均：社員をランダムにn人選んだときの集団の身長の平均。選ぶたびに値が変わる。

標本平均は必ずしも母平均とは等しくならないが、①(サンプル)サイズを増やしたり、②標本数を増やすと、母平均に近づく。

例えば、標準正規分布から5個乱数を選んだ時(サンプルサイズ5の1標本)の平均は、何回繰り返しても、0にならない。
```{r}
mean(rnorm(5)) 
```


①標準正規分布から1万個の乱数を選んだ時(サンプルサイズ1万個の1標本)の平均はより0に近い。
```{r}
mean(rnorm(10000))
```

②「標準正規分布から5個乱数を選んだ時の平均」を1万個計算(サンプルサイズ5の1万標本)して、その平均をとったときの値は、より0に近い。
```{r}
mean(replicate(10000, mean(rnorm(5))))
```

平均には以下の性質がある(線形性、というが、覚えなくてよい)。
```{r}
X = c(1,2,3,4,5)
Y = c(5,3,1,8,9)
```

```{r}
2 * X
3 * Y
mean(2 * X + 3 * Y) # この計算と…
2 * mean(X) + 3 * mean(Y) # この計算が、同じ値になる性質を、線形性という
```

## 2.4 分散と標準偏差

分散あるいは母分散、またはその平方根である標準偏差は、確率分布(ヒストグラム)のばらつきの度合いを表す。
正規分布で見てみよう。

```{r}
hist(rnorm(10000)) # 標準正規分布のヒストグラム。つまり、標準偏差は1、分散も1
hist(rnorm(10000, sd = 2)) # 平均0、標準偏差は2(分散なら4)の正規分布
hist(rnorm(10000, sd = 10)) # 平均0、標準偏差は10(分散なら100)の正規分布
```

あるサイズnの標本の分散を計算したいが、分散の計算式には、母平均を使うことになっている。
しかし、母平均は分からないことも多い(例えば、母集団を東京都民とすると、その身長の母平均を求めるのは困難を極める)。
なので、標本分散の計算に、母平均ではなく、標本平均を使う。
また、このときサンプルサイズnで割らず、n-1で割る。
すると、この計算で求めた標本分散の平均は母分散と一致する。
n-1で割らず、nで割ると、母分散と一致しない。
「n-1で割る分散」の意味を確かめるために、数値実験をしてみよう。

```{r}
x = 1:5 # 母集団
x
var(x) # 母分散
var(c(2,3,4,5)) # 標本分散1
var(c(1,3,4,5)) # 標本分散2
var(c(1,2,4,5)) # 標本分散3
var(c(1,2,3,5)) # 標本分散4
var(c(1,2,3,4)) # 標本分散5
#　標本分散の平均 = 母分散
mean(c(var(c(2,3,4,5)), var(c(1,3,4,5)), var(c(1,2,4,5)), var(c(1,2,3,5)), var(c(1,2,3,4))))
```

「nで割る分散」で数値実験をしてみる。

まずは、「nで割る分散」を計算する関数を作る。
```{r}
varp <- function(x){var(x) * (length(x) - 1) / length(x)} 
```

```{r}
varp(x) # 母分散
varp(c(2,3,4,5)) # 標本分散1
varp(c(1,3,4,5)) # 標本分散2
varp(c(1,2,4,5)) # 標本分散3
varp(c(1,2,3,5)) # 標本分散4
varp(c(1,2,3,4)) # 標本分散5
#　標本分散の平均 ≠ 母分散
mean(c(varp(c(2,3,4,5)), varp(c(1,3,4,5)), varp(c(1,2,4,5)), varp(c(1,2,3,5)), varp(c(1,2,3,4))))
```

「n-1で割る分散」(の平均値)は、母分散からのズレ(バイアス、bias)がない。
なので、このズレのなさ(＝偏りのなさ)から、不偏分散、または母分散の不偏推定量という。

sd関数は、標本の標準偏差を求める。計算式は、不偏分散の平方根である。
```{r}
x = 1:10
var(x)
sqrt(var(x)) # 不偏分散の平方根
sd(x) # 標本の標準偏差
```

さて、ある確率分布の標本平均を考える。標本平均なので、標本をとるたびにその値は変わるが、①サンプル数を大きくするか、②標本数を大きくすれば、標本平均は確率分布の母平均に近づくことを2.3で述べた。
  
いま、サンプル数(教科書では、測定回数)をnにして、標本数を一定(例えば、20)にしたとき、20個の標本平均が手に入ることになる。さらにこの「20個の標本平均」の「平均」と「標準偏差(標準誤差、と言う)」も計算できる。実際に数値で見てみよう。

```{r}
mean(rnorm(5)) # 標準正規分布からサンプル数5の標本平均を求める
replicate(20, mean(rnorm(5))) # 標準正規分布からサンプル数5の標本平均を、20回求める
mean(replicate(20, mean(rnorm(5)))) # 20個の標本平均の平均を求める
sd(replicate(20, mean(rnorm(5)))) # 20個の標本平均の標準偏差(＝標準誤差)を求める
```

さて教科書2.3の①で、サンプル数(測定回数)nを増やすと「標本平均の平均」は母平均に近づくことは述べたが、「標本平均の標準偏差」(＝標準誤差)は、1/√nに比例するらしい。つまり、サンプル数(測定回数)が100倍になるなら1/10になるし、10000倍になるなら1/100になるということだ。実験してみよう。

```{r}
sd(replicate(20, mean(rnorm(10)))) # サンプル数10で標本数20、標本平均20個の標準偏差
sd(replicate(20, mean(rnorm(1000)))) # サンプル数1000(10の100倍)で標本数20、標本平均20個の標準偏差
sd(replicate(20, mean(rnorm(100000)))) # サンプル数100000(10の10000倍)で標本数20、標本平均20個の標準偏差
```

nが増えるたびに、「標本平均の標準偏差」(＝標準誤差)が反比例していく。ぴったり1/10や1/100ではないが、大体数字のオーダーはあっていることが確認できる。  
さらにヒストグラムを描いて、確かめてみよう。ついでに、今度は標本数を20ではなく、100にしてみる。

```{r}
hist(replicate(100, mean(rnorm(10)))) # サンプル数10で標本数100、標本平均100個分のヒストグラム
hist(replicate(100, mean(rnorm(1000))))  # サンプル数1000で標本数100、標本平均100個分のヒストグラム
hist(replicate(100, mean(rnorm(100000))))  # サンプル数100000で標本数100、標本平均100個分のヒストグラム
```

標準偏差とはデータのばらつき具合だったが、ヒストグラムの横軸に注目してみると、ばらつき具合がどんどん小さくなっていく。  
さらに、最大値、最小値や、四分位数を見てみよう。今度は標本数を20ではなく、50にしてみる。

```{r}
summary(replicate(50, mean(rnorm(10))))
summary(replicate(50, mean(rnorm(1000))))
summary(replicate(50, mean(rnorm(100000))))
```

サンプル数を100倍すると、最小値や最大値が、大体1/10くらいになっていることがわかる。

以上より、母平均が分からなくても、ランダムに十分なサンプル数がとれれば(nが十分に大きければ)、標本平均は母平均に近づき、かつ、母平均からのブレ幅(標本平均の標準誤差)も小さくなるので、全数調査をしなくても母平均に十分近しい値がわかる、ということである。  これは、標本平均の標準誤差の性質(1/√n倍になる)による。
多くの人は感覚でわかることかもしれないが、ここでは数値実験で確かめてみた。

## 2.5 中心極限定理と正規分布

一様分布、という確率変数がある。rでは、runif関数で、一様分布(**unif**orm distribution)に従う乱数(一様乱数)をつくることができる。ヒストグラムで一様乱数の形を見てみよう。

```{r}
hist(runif(10000)) # 10000個の一様乱数のヒストグラム
hist(runif(10000), freq = FALSE) # ヒストグラムにオプションをつけてみました。なにが変わったかわかりますか？
```

一様乱数の平均値と分散を計算してみよう。

```{r}
mean(runif(10000))
var(runif(10000))
```

runif関数のデフォルト値は、最大値1、最小値0となるので、平均は0.5となる。分散の計算は、積分とかが出てきて難しいので省略する。

さて、10000個の一様乱数を2セット持ってきて、10000の各成分ごとに足して、足した結果、10000個になった乱数をヒストグラムにしてみよう。  これまでの言い方を踏襲するなら、「一様乱数のサンプル数10000の2標本を成分ごとに足して、ヒストグラムにする」となる。

```{r}
hist(runif(10000) + runif(10000))
```

三角形になった。グラフから読み取ると、平均値は1に近いようだ。平均値0.5の一様乱数を二つ足したのだから、平均値は2倍されて1になるだろう、と言われると、納得できる。ちなみに分散を計算してみると`r var(runif(10000) + runif(10000))`となり、やっぱり2倍くらいになっている。

では、3標本にするとどうなるか。

```{r}
hist(runif(10000) + runif(10000) + runif(10000))
```

3標本だと、釣り鐘型になってきた。正規分布に近いのではないだろうか。平均値は想像通り1.5だし、分散も`r var(runif(10000) + runif(10000) + runif(10000))`、やはり3倍くらいになっている。

でも、runifを3回足すのも疲れてきた。3倍してはいけないのだろうか？

```{r}
hist(runif(10000) * 3)
```

これだとうまくいかない。なぜだろうか？「グラフの横軸」をヒントに、rでどのような計算がされるか、考えてみよう(各自宿題)。

さて、突然だが、さっき計算した「一様乱数の分散」の逆数を、計算してみよう。

```{r}
1 / var(runif(10000))
```

12くらいの値になった。つまり、一様乱数の分散は、だいたい1/12くらいの値になるということだ。  
では、分散を1にするために、一様乱数を12個足したヒストグラムを見てみよう。

```{r}
hist(runif(10000) + runif(10000) + runif(10000) + runif(10000) + runif(10000) + runif(10000) + runif(10000) + runif(10000) + runif(10000) + runif(10000) + runif(10000) + runif(10000))
```

これで分散は1になったが、今度は平均値が6くらいになってしまったので、6を引いてみよう。6を引いても、分散の値は変わらないことに注意する。

```{r}
hist(runif(10000) + runif(10000) + runif(10000) + runif(10000) + runif(10000) + runif(10000) + runif(10000) + runif(10000) + runif(10000) + runif(10000) + runif(10000) + runif(10000) - 6)
```

さて、これで、平均値0、分散1のヒストグラムができた。さて、どこかで見たような…

```{r}
hist(rnorm(10000))
```

そう、これは標準正規分布(つまり平均0、分散1の正規分布)と同じようにみえる。  
これが、中心極限定理である。rのおかげで、数式を使わずに、中心極限定理を体感できた。

さて、教科書を見ると、「nが十分に大きくなると」という条件がある。ここまではn = 10000として計算してきたが、n = 5のように小さくすると、中心極限定理は成り立たないのだろうか？実験してみよう。さっきと同じようにrunifを12回足すが、各々サンプル数は5にしてみる。

```{r}
hist(runif(5) + runif(5) + runif(5) + runif(5) + runif(5) + runif(5) + runif(5) + runif(5) + runif(5) + runif(5) + runif(5) + runif(5) - 6)
```

やはり、正規分布には見えない。では、n = 50ではどうなるか。

```{r}
hist(runif(50) + runif(50) + runif(50) + runif(50) + runif(50) + runif(50) + runif(50) + runif(50) + runif(50) + runif(50) + runif(50) + runif(50) - 6)
```

やっぱり正規分布には見えない。  
nが沢山あるときのありがたさを感じたい。

これ以降、教科書では正規分布を例にして、密度関数dnorm、分布関数pnorm、分位関数qnorm、乱数を発生させるrnormの話が始まるが、ここでは割愛する。  
なお、以前、分布関数pnormと確率と面積の話をしたことがある。忘れた方は復習をお願いしたい。

## 2.6 コーシー分布
(省略)

## 2.7 正規分布から導かれる分布
(省略)