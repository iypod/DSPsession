---
title: "Chapter3 2項分布、検定、信頼区間"
output: 
  github_document:
    toc: TRUE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
set.seed(123)
```

```{r , include=FALSE}
library(tidyverse)
```


## 3.1 2項分布

次のような事象を考えてみる。

1. 「50%の確率で表がでる硬貨」を「10回投げた」とき、「表が出た硬貨が5枚になる確率」は?
1. 「1%の確率で当たる宝くじ」を「1000枚買った」とき、「当たりくじが10枚になる確率」は?
1. 「1年以内の死亡率が0.2%であることが分かっている集団」で「1万人を選んだ」とき、「1年後の死亡者が15人になる確率」は?

もっと一般に(つまり"5枚"や"10枚"や"15人"ではなく)、次のような事象を考えてみる。

1. 「50%の確率で表がでる硬貨」を「10回投げた」とき、「表が出た硬貨がr枚になる確率」は?
1. 「1%の確率で当たる宝くじ」を「1000枚買った」とき、「当たりくじがr枚になる確率」は?
1. 「1年以内の死亡率が0.2%であることが分かっている集団」で「1万人を選んだ」とき、「1年後の死亡者がr人になる確率」は?

「①ある確率でおこる事象(例、50%の確率で表がでる、1%の確率で当たる宝くじ、etc)」を「②ある回数だけ繰り返す(例、10回投げた)」または「②ある分だけ集める(例、1000枚買った)」ときの確率分布を、2項分布、という。   
2項分布のインプットに必要な変数は①と②であり、アウトプットは「③事象がr回起こる確率」の確率分布になる。   
例えば、上記1～3の2項分布は以下のようなグラフになる。

```{r , echo=FALSE}

ggplot(data = data.frame(x = 0:10, y = dbinom(0:10, size = 10, prob = 0.5)), aes(x, y)) +
  geom_col() +
  geom_text(aes(label = format(y, digits = 1)), nudge_y = 0.01) +
  scale_x_continuous(breaks = 0:10) +
  labs(x = "表の枚数rごとの確率", y = "確率") +
  ggtitle("「①表が出る確率50%、②硬貨を投げる回数10」としたときの2項分布")

```

```{r, echo=FALSE}
ggplot(data = data.frame(x = 0:25, y = dbinom(0:25, size = 1000, prob = 0.01)), aes(x, y)) +
  geom_col() +
  scale_x_continuous(breaks = 0:25) +
  labs(x = "当たった宝くじrごとの確率", y = "確率") +
  ggtitle("「①1%の確率で当たる宝くじ」を「②1000枚買った」ときの2項分布")
```

```{r, echo=FALSE}
ggplot(data = data.frame(x = 0:40, y = dbinom(0:40, size = 10000, prob = 0.002)), aes(x, y)) +
  geom_col() +
  scale_x_continuous(breaks = 0:40) +
  labs(x = "死亡する人数がr人となる時の確率", y = "確率") +
  ggtitle("「1年以内の死亡率が0.2%であることが分かっている集団」で「1万人を選んだ」ときの2項分布")
```

教科書では、①をθ(シータ、と読む)、②をn、③がr と書いてある。  
また、「rが2項分布(**Binom**ial distribution)に従う」ことを「r ~ Binom(n, θ)」と書くことにしている。  

# 3.2 統計的仮説検定の考え方

いま、硬貨を10回投げたら、2回表が出た。 
この硬貨は公正に作られているだろうか?   
それともイカサマを疑ったほうがいいのか?   
(今回は「イカサマだ!」と言いたい心情になってください)   

以下では、統計的仮説検定の枠組みで、「硬貨を10回投げたら、2回表が出た」ということがイカサマであるかどうか、確認してみよう。

- まずは、証明したい仮説と、否定したい仮説を思い描く
    - 証明したい仮説を「対立仮説」、否定したい仮説を「帰無仮説」と呼ぶことにする
    - 例えば、硬貨がイカサマであることを証明したいときは、
        - 対立仮説：「硬貨がイカサマである」
        - 帰無仮説：「硬貨はイカサマではない(公正である)」
- 否定したい仮説(帰無仮説)「硬貨はイカサマではない(公正である)」をもとにした確率密度関数※を描く
    - ①イカサマのない公正な硬貨であれば、表と裏がでる確率は等しく0.5となる
    - ②硬貨は10回投げた
    - 「①表が出る確率0.5、②硬貨を投げる回数10」としたときの確率分布は、2項分布で(binomial distribution)で求められ、Binom(n = 10, θ = 0.5)、となる
    - 以下は、Binom(n = 10, θ = 0.5)としたときの確率密度関数※のグラフである

※2項分布のときは、「確率密度関数」ではなく「確率質量関数」と呼ぶのが正しいが、両者は同じものだと思ってよい。どちらも「面積 = 確率」となるような関数である

```{r}
ggplot(data = data.frame(x = 0:10, y = dbinom(0:10, size = 10, prob = 0.5)), aes(x, y)) +
  geom_col() +
  geom_text(aes(label = format(y, digits = 1)), nudge_y = 0.01) +
  scale_x_continuous(breaks = 0:10) +
  ggtitle("「①表が出る確率0.5、②硬貨を投げる回数10」としたときの2項分布")
```

- この確率密度関数で、「現実に起きたこと」または「それよりも珍しいこと」が起こる確率を求める。これをp値(ピーチ)と呼ぶ
    - 現実に起きたこと：「硬貨を10回投げたら2回表が出た」(オレンジ色の面積)
    - 現実に起きたことより珍しいこと(緑の面積)
    - オレンジと緑の面積(=確率)の合計値は`r sum(dbinom(0:2, size = 10, prob = 0.5)) * 2`であり、これがp値である

```{r}
ggplot(data = data.frame(x = 0:10,
                         y = dbinom(0:10, size = 10, prob = 0.5),
                         yy = c(dbinom(0:2, size = 10, prob = 0.5), rep(0, 5), dbinom(8:10, size = 10, prob = 0.5)),
                         yyy = c(rep(0,2), dbinom(2, size = 10, prob = 0.5), rep(0,8))),
       aes(x, y)) +
  geom_col() +
  geom_text(aes(label = format(y, digits = 1)), nudge_y = 0.01) +
  geom_col(aes(y = yy), fill = "chartreuse1") +
  geom_col(aes(y = yyy), fill = "orange") +
  scale_x_continuous(breaks = 0:10) +
  ggtitle("「①表が出る確率0.5、②硬貨を投げる回数10」としたときの2項分布で\n「表が2回出る」か「それよりも珍しいことが起こる」確率")
```

- 上記のp値の値を持って、「否定したい仮説(帰無仮説)」を否定できるか判断する
    - 今回のp値は`r sum(dbinom(0:2, size = 10, prob = 0.5)) * 2`であった
    - これを翻訳すると「公正に作られた硬貨であっても、`r sum(dbinom(0:2, size = 10, prob = 0.5)) * 2 * 100`%くらいの確率で、表が2枚しかでないこと、またはそれよりももっと珍しいこと(表が1枚、0枚など)が起こる」という意味合いになる
    - 10%程度の確率を「まれなこと」と考える場合は、「公正に作られた硬貨にしてはまれなことが起こっている。つまり、この硬貨は公正に作られていない」と結論できる
        - 「帰無仮説は棄却された」と言う
    - 10%程度なら「起こりうる」と考える場合は、「公正に作られた硬貨で、今回たまたま10%程度の事象が起こったのかもしれない」と考える
        - 「帰無仮説は棄却できない」と言う
        - 「帰無仮説が正しかった」という意味ではない
    - 実際には、5%という値を境にして、判断することが多いようである(5%に明確な根拠はない)